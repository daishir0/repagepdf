# データベース設計書

## 概要
RePage PDFシステムのデータベース詳細設計です。
Phase2のER図を基に、物理設計（DDL、インデックス、制約）を定義します。

## ステータス
- **フェーズ**: 詳細設計
- **作成日**: 2025-12-16
- **更新日**: 2025-12-16
- **作成者**: Claude (AIPM)
- **レビュー状況**: 未着手

---

## 内容

### データベース基本設計

| 項目 | 設定値 |
|------|--------|
| DBMS | SQLite 3.x（標準） / PostgreSQL 15.x（切替可能） |
| 文字コード | UTF-8 |
| 照合順序 | NOCASE（SQLite） / ja_JP.UTF-8（PostgreSQL） |
| タイムゾーン | Asia/Tokyo |

---

### テーブル一覧

| テーブル名 | 説明 | レコード数見込み |
|------------|------|------------------|
| users | システムユーザー | 〜10件（Phase1は管理者のみ） |
| templates | サイトテンプレート | 〜50件 |
| conversions | PDF変換履歴 | 〜1,000件/月 |
| extracted_images | 抽出画像 | 〜10,000件/月 |
| settings | ユーザー設定 | ユーザー数と同数 |

---

### テーブル物理設計

#### 1. users（ユーザー）

**テーブル定義:**

```sql
-- SQLite版
CREATE TABLE users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    email VARCHAR(255) NOT NULL UNIQUE,
    password_hash VARCHAR(255) NOT NULL,
    name VARCHAR(100),
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- インデックス
CREATE UNIQUE INDEX idx_users_email ON users(email);

-- トリガー（updated_at自動更新）
CREATE TRIGGER trg_users_updated_at
AFTER UPDATE ON users
BEGIN
    UPDATE users SET updated_at = CURRENT_TIMESTAMP WHERE id = NEW.id;
END;
```

**カラム詳細:**

| カラム名 | データ型 | PK | FK | UK | NN | デフォルト | 説明 |
|----------|----------|----|----|----|----|------------|------|
| id | INTEGER | PK | - | - | NN | AUTO | 主キー |
| email | VARCHAR(255) | - | - | UK | NN | - | メールアドレス |
| password_hash | VARCHAR(255) | - | - | - | NN | - | bcryptハッシュ |
| name | VARCHAR(100) | - | - | - | - | NULL | 表示名 |
| created_at | DATETIME | - | - | - | NN | CURRENT_TIMESTAMP | 作成日時 |
| updated_at | DATETIME | - | - | - | NN | CURRENT_TIMESTAMP | 更新日時 |

---

#### 2. templates（テンプレート）

**テーブル定義:**

```sql
CREATE TABLE templates (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    name VARCHAR(200) NOT NULL,
    url1 VARCHAR(2000) NOT NULL,
    url2 VARCHAR(2000),
    url3 VARCHAR(2000),
    learned_rules TEXT,
    status VARCHAR(20) NOT NULL DEFAULT 'pending',
    error_message TEXT,
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);

-- インデックス
CREATE INDEX idx_templates_user_id ON templates(user_id);
CREATE INDEX idx_templates_status ON templates(status);

-- トリガー
CREATE TRIGGER trg_templates_updated_at
AFTER UPDATE ON templates
BEGIN
    UPDATE templates SET updated_at = CURRENT_TIMESTAMP WHERE id = NEW.id;
END;
```

**カラム詳細:**

| カラム名 | データ型 | PK | FK | UK | NN | デフォルト | 説明 |
|----------|----------|----|----|----|----|------------|------|
| id | INTEGER | PK | - | - | NN | AUTO | 主キー |
| user_id | INTEGER | - | FK | - | NN | - | 作成者ID |
| name | VARCHAR(200) | - | - | - | NN | - | テンプレート名 |
| url1 | VARCHAR(2000) | - | - | - | NN | - | 学習用URL 1 |
| url2 | VARCHAR(2000) | - | - | - | - | NULL | 学習用URL 2 |
| url3 | VARCHAR(2000) | - | - | - | - | NULL | 学習用URL 3 |
| learned_rules | TEXT | - | - | - | - | NULL | 学習ルール（JSON） |
| status | VARCHAR(20) | - | - | - | NN | 'pending' | ステータス |
| error_message | TEXT | - | - | - | - | NULL | エラーメッセージ |
| created_at | DATETIME | - | - | - | NN | CURRENT_TIMESTAMP | 作成日時 |
| updated_at | DATETIME | - | - | - | NN | CURRENT_TIMESTAMP | 更新日時 |

**ステータス遷移:**

```
pending → learning → ready
              ↓
            error
```

| ステータス | 説明 |
|-----------|------|
| pending | 作成直後（学習未実行） |
| learning | 学習処理中 |
| ready | 学習完了（使用可能） |
| error | 学習エラー |

**learned_rules JSONスキーマ:**

```json
{
  "site_name": "〇〇市公式サイト",
  "base_url": "https://example.city.lg.jp",
  "html_structure": {
    "article_wrapper": "article.content",
    "heading_classes": {
      "h1": "page-title",
      "h2": "section-title",
      "h3": "subsection-title"
    },
    "paragraph_class": "content-text",
    "list_class": "content-list",
    "table_class": "data-table"
  },
  "css_rules": [
    ".page-title { font-size: 24px; font-weight: bold; }",
    ".section-title { font-size: 20px; border-bottom: 2px solid #333; }"
  ],
  "meta": {
    "learned_at": "2025-12-16T10:00:00Z",
    "source_urls": ["url1", "url2", "url3"]
  }
}
```

---

#### 3. conversions（変換）

**テーブル定義:**

```sql
CREATE TABLE conversions (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    template_id INTEGER NOT NULL,
    original_filename VARCHAR(255) NOT NULL,
    pdf_path VARCHAR(500) NOT NULL,
    generated_html TEXT,
    status VARCHAR(20) NOT NULL DEFAULT 'uploading',
    converter_used VARCHAR(50),
    page_count INTEGER,
    error_message TEXT,
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    approved_at DATETIME,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (template_id) REFERENCES templates(id) ON DELETE RESTRICT
);

-- インデックス
CREATE INDEX idx_conversions_user_id ON conversions(user_id);
CREATE INDEX idx_conversions_template_id ON conversions(template_id);
CREATE INDEX idx_conversions_status ON conversions(status);
CREATE INDEX idx_conversions_created_at ON conversions(created_at DESC);

-- トリガー
CREATE TRIGGER trg_conversions_updated_at
AFTER UPDATE ON conversions
BEGIN
    UPDATE conversions SET updated_at = CURRENT_TIMESTAMP WHERE id = NEW.id;
END;
```

**カラム詳細:**

| カラム名 | データ型 | PK | FK | UK | NN | デフォルト | 説明 |
|----------|----------|----|----|----|----|------------|------|
| id | INTEGER | PK | - | - | NN | AUTO | 主キー |
| user_id | INTEGER | - | FK | - | NN | - | 作成者ID |
| template_id | INTEGER | - | FK | - | NN | - | テンプレートID |
| original_filename | VARCHAR(255) | - | - | - | NN | - | 元PDFファイル名 |
| pdf_path | VARCHAR(500) | - | - | - | NN | - | PDF保存パス |
| generated_html | TEXT | - | - | - | - | NULL | 生成HTML |
| status | VARCHAR(20) | - | - | - | NN | 'uploading' | ステータス |
| converter_used | VARCHAR(50) | - | - | - | - | NULL | 使用コンバーター |
| page_count | INTEGER | - | - | - | - | NULL | PDFページ数 |
| error_message | TEXT | - | - | - | - | NULL | エラーメッセージ |
| created_at | DATETIME | - | - | - | NN | CURRENT_TIMESTAMP | 作成日時 |
| updated_at | DATETIME | - | - | - | NN | CURRENT_TIMESTAMP | 更新日時 |
| approved_at | DATETIME | - | - | - | - | NULL | 承認日時 |

**ステータス遷移:**

```
uploading → uploaded → converting → converted → approved
                           ↓
                         error
```

---

#### 4. extracted_images（抽出画像）

**テーブル定義:**

```sql
CREATE TABLE extracted_images (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    conversion_id INTEGER NOT NULL,
    filename VARCHAR(255) NOT NULL,
    file_path VARCHAR(500) NOT NULL,
    page_number INTEGER NOT NULL,
    order_in_page INTEGER NOT NULL DEFAULT 0,
    width INTEGER,
    height INTEGER,
    file_size INTEGER,
    mime_type VARCHAR(50),
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (conversion_id) REFERENCES conversions(id) ON DELETE CASCADE
);

-- インデックス
CREATE INDEX idx_extracted_images_conversion_id ON extracted_images(conversion_id);
CREATE INDEX idx_extracted_images_page_number ON extracted_images(conversion_id, page_number);
```

**カラム詳細:**

| カラム名 | データ型 | PK | FK | UK | NN | デフォルト | 説明 |
|----------|----------|----|----|----|----|------------|------|
| id | INTEGER | PK | - | - | NN | AUTO | 主キー |
| conversion_id | INTEGER | - | FK | - | NN | - | 変換ID |
| filename | VARCHAR(255) | - | - | - | NN | - | ファイル名 |
| file_path | VARCHAR(500) | - | - | - | NN | - | 保存パス |
| page_number | INTEGER | - | - | - | NN | - | PDFページ番号 |
| order_in_page | INTEGER | - | - | - | NN | 0 | ページ内順序 |
| width | INTEGER | - | - | - | - | NULL | 画像幅(px) |
| height | INTEGER | - | - | - | - | NULL | 画像高さ(px) |
| file_size | INTEGER | - | - | - | - | NULL | ファイルサイズ(bytes) |
| mime_type | VARCHAR(50) | - | - | - | - | NULL | MIMEタイプ |
| created_at | DATETIME | - | - | - | NN | CURRENT_TIMESTAMP | 作成日時 |

---

#### 5. settings（設定）

**テーブル定義:**

```sql
CREATE TABLE settings (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL UNIQUE,
    current_converter VARCHAR(50) NOT NULL DEFAULT 'pymupdf',
    openai_model VARCHAR(50) NOT NULL DEFAULT 'gpt-4o-mini',
    anthropic_model VARCHAR(50) NOT NULL DEFAULT 'claude-3-haiku-20240307',
    openai_api_key_enc TEXT,
    anthropic_api_key_enc TEXT,
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);

-- インデックス
CREATE UNIQUE INDEX idx_settings_user_id ON settings(user_id);

-- トリガー
CREATE TRIGGER trg_settings_updated_at
AFTER UPDATE ON settings
BEGIN
    UPDATE settings SET updated_at = CURRENT_TIMESTAMP WHERE id = NEW.id;
END;
```

**カラム詳細:**

| カラム名 | データ型 | PK | FK | UK | NN | デフォルト | 説明 |
|----------|----------|----|----|----|----|------------|------|
| id | INTEGER | PK | - | - | NN | AUTO | 主キー |
| user_id | INTEGER | - | FK | UK | NN | - | ユーザーID |
| current_converter | VARCHAR(50) | - | - | - | NN | 'pymupdf' | コンバーター |
| openai_model | VARCHAR(50) | - | - | - | NN | 'gpt-4o-mini' | OpenAIモデル |
| anthropic_model | VARCHAR(50) | - | - | - | NN | 'claude-3-haiku-20240307' | Anthropicモデル |
| openai_api_key_enc | TEXT | - | - | - | - | NULL | OpenAI APIキー（暗号化） |
| anthropic_api_key_enc | TEXT | - | - | - | - | NULL | Anthropic APIキー（暗号化） |
| updated_at | DATETIME | - | - | - | NN | CURRENT_TIMESTAMP | 更新日時 |

**暗号化仕様:**
- 暗号化方式: Fernet（AES-128-CBC + HMAC-SHA256）
- 鍵: 環境変数 `ENCRYPTION_KEY`（Fernet互換の32バイトBase64キー）
- 保存形式: Fernetトークン（Base64エンコード）
- 参照: クラス設計書 `security.py` の `SecurityService` クラス

---

### 初期データ

```sql
-- 管理者ユーザー（パスワードはセットアップ時に設定）
INSERT INTO users (email, password_hash, name)
VALUES ('admin@example.com', '$2b$12$xxxxx', '管理者');

-- 管理者の初期設定
INSERT INTO settings (user_id, current_converter, openai_model, anthropic_model)
VALUES (1, 'pymupdf', 'gpt-4o-mini', 'claude-3-haiku-20240307');
```

---

### マイグレーション戦略

**SQLite → PostgreSQL移行時の変更点:**

| SQLite | PostgreSQL | 備考 |
|--------|------------|------|
| INTEGER PRIMARY KEY AUTOINCREMENT | SERIAL | 自動採番 |
| DATETIME | TIMESTAMP WITH TIME ZONE | タイムゾーン対応 |
| TEXT | TEXT | 変更なし |
| トリガー構文 | PL/pgSQL | 書き換え必要 |

**PostgreSQL版DDL例:**

```sql
-- PostgreSQL版（主要な違いのみ）
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    email VARCHAR(255) NOT NULL UNIQUE,
    password_hash VARCHAR(255) NOT NULL,
    name VARCHAR(100),
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW()
);

-- updated_atトリガー関数
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ language 'plpgsql';

CREATE TRIGGER trg_users_updated_at
BEFORE UPDATE ON users
FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

---

### バックアップ設計

| 項目 | 設定 |
|------|------|
| バックアップ頻度 | 日次（深夜2:00） |
| 保持期間 | 7日間 |
| バックアップ先 | ./backups/ |
| 方式 | SQLiteファイルコピー |

**バックアップスクリプト例:**

```bash
#!/bin/bash
BACKUP_DIR="./backups"
DB_FILE="./data/repage.db"
DATE=$(date +%Y%m%d_%H%M%S)

cp "$DB_FILE" "$BACKUP_DIR/repage_$DATE.db"

# 7日以上古いバックアップを削除
find "$BACKUP_DIR" -name "repage_*.db" -mtime +7 -delete
```

---

## 変更履歴
| 日付 | 版 | 変更内容 | 変更者 |
|------|-----|----------|--------|
| 2025-12-16 | 1.0 | 初版作成 | Claude (AIPM) |

---

## AIレビュー結果

### レビュー実施日: 2025-12-16

### レビュー結果: 合格（修正済み）

### 検出項目と対応:

| # | 項目 | 重要度 | 内容 | 対応 |
|---|------|--------|------|------|
| 1 | 暗号化方式の不整合 | 高 | AES-256-GCMと記載していたがクラス設計書ではFernet使用 | Fernet（AES-128-CBC + HMAC-SHA256）に統一 |

### 確認事項:
- [x] 全テーブルのDDLが定義されている
- [x] インデックスが適切に設定されている
- [x] 外部キー制約が正しく定義されている
- [x] トリガーでupdated_at自動更新が設定されている
- [x] PostgreSQL移行戦略が記載されている
- [x] バックアップ設計が記載されている
- [x] クラス設計書のSQLAlchemyモデルと整合している
