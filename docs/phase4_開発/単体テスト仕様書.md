# 単体テスト仕様書

## 概要
RePage PDFシステムの単体テスト仕様書。バックエンドの各モジュール（サービス層、コンバーター、API）に対する単体テスト項目を定義する。

**注記**: 本プロジェクトでは、Phase 5でPlaywrightによるE2Eテストを重点的に実施するため、単体テストはコア機能に絞って実施する。

## ステータス
- **フェーズ**: 開発
- **作成日**: 2025-12-12
- **更新日**: 2025-12-16
- **作成者**: Claude (AIPM)
- **レビュー状況**: 完了

---

## テスト方針

### テストフレームワーク

| レイヤー | フレームワーク | 備考 |
|---------|--------------|------|
| バックエンド | pytest | Python標準テストフレームワーク |
| フロントエンド | - | E2Eテスト（Phase 5）で代替 |

### テストカバレッジ目標

| カテゴリ | 目標 | 備考 |
|---------|------|------|
| コア機能（認証・暗号化） | 80%以上 | セキュリティ重要箇所 |
| サービス層 | 70%以上 | ビジネスロジック |
| コンバーター | 60%以上 | 外部依存が多い |
| API層 | E2Eで代替 | Phase 5で実施 |

---

## テスト項目一覧

### 1. 認証・セキュリティ (`app/core/security.py`)

| テストID | テスト項目 | 入力 | 期待結果 |
|----------|-----------|------|---------|
| UT-SEC-001 | パスワードハッシュ化 | 平文パスワード | bcryptハッシュ値 |
| UT-SEC-002 | パスワード検証（正常） | 平文, ハッシュ | True |
| UT-SEC-003 | パスワード検証（異常） | 誤った平文, ハッシュ | False |
| UT-SEC-004 | JWTトークン生成 | user_id | 有効なJWT文字列 |
| UT-SEC-005 | JWTトークン検証（正常） | 有効なJWT | デコード成功 |
| UT-SEC-006 | JWTトークン検証（期限切れ） | 期限切れJWT | 例外発生 |
| UT-SEC-007 | APIキー暗号化 | 平文APIキー | Fernet暗号文 |
| UT-SEC-008 | APIキー復号化 | Fernet暗号文 | 平文APIキー |

### 2. 認証サービス (`app/services/auth_service.py`)

| テストID | テスト項目 | 入力 | 期待結果 |
|----------|-----------|------|---------|
| UT-AUTH-001 | ユーザー認証（正常） | 正しいメール/パスワード | Userオブジェクト |
| UT-AUTH-002 | ユーザー認証（メール不正） | 存在しないメール | None |
| UT-AUTH-003 | ユーザー認証（パスワード不正） | 誤ったパスワード | None |
| UT-AUTH-004 | ユーザー登録 | 新規ユーザー情報 | Userオブジェクト |
| UT-AUTH-005 | ユーザー登録（重複メール） | 既存メール | 例外発生 |

### 3. テンプレートサービス (`app/services/template_service.py`)

| テストID | テスト項目 | 入力 | 期待結果 |
|----------|-----------|------|---------|
| UT-TPL-001 | テンプレート作成 | 名前, URL | Templateオブジェクト |
| UT-TPL-002 | テンプレート取得 | テンプレートID | Templateオブジェクト |
| UT-TPL-003 | テンプレート取得（存在しない） | 無効なID | None |
| UT-TPL-004 | テンプレート一覧 | user_id | Templateリスト |
| UT-TPL-005 | テンプレート更新 | ID, 更新データ | 更新されたTemplate |
| UT-TPL-006 | テンプレート削除 | テンプレートID | 削除成功 |

### 4. 変換サービス (`app/services/conversion_service.py`)

| テストID | テスト項目 | 入力 | 期待結果 |
|----------|-----------|------|---------|
| UT-CNV-001 | 変換作成 | PDFパス, テンプレートID | Conversionオブジェクト |
| UT-CNV-002 | 変換取得 | 変換ID | Conversionオブジェクト |
| UT-CNV-003 | 変換一覧 | user_id | Conversionリスト |
| UT-CNV-004 | 変換削除 | 変換ID | 削除成功 |

### 5. PDFコンバーター (`app/converters/`)

#### 5.1 PyMuPDFコンバーター

| テストID | テスト項目 | 入力 | 期待結果 |
|----------|-----------|------|---------|
| UT-PMU-001 | テキスト抽出 | サンプルPDF | テキスト文字列 |
| UT-PMU-002 | 画像抽出 | 画像含むPDF | ExtractedImageリスト |
| UT-PMU-003 | 空PDF | 空のPDF | 空文字列 |

#### 5.2 pdfplumberコンバーター

| テストID | テスト項目 | 入力 | 期待結果 |
|----------|-----------|------|---------|
| UT-PLB-001 | テキスト抽出 | サンプルPDF | テキスト文字列 |
| UT-PLB-002 | 表抽出 | 表含むPDF | Tableリスト |
| UT-PLB-003 | 複雑な表 | 結合セル含むPDF | 正しいTable構造 |

#### 5.3 コンバーターマネージャー

| テストID | テスト項目 | 入力 | 期待結果 |
|----------|-----------|------|---------|
| UT-MGR-001 | コンバーター取得（pymupdf） | "pymupdf" | PyMuPDFConverter |
| UT-MGR-002 | コンバーター取得（pdfplumber） | "pdfplumber" | PdfplumberConverter |
| UT-MGR-003 | コンバーター取得（無効） | "invalid" | 例外発生 |

### 6. 設定サービス (`app/services/settings_service.py`)

| テストID | テスト項目 | 入力 | 期待結果 |
|----------|-----------|------|---------|
| UT-SET-001 | 設定取得 | user_id | UserSettingsオブジェクト |
| UT-SET-002 | 設定更新 | user_id, 更新データ | 更新されたSettings |
| UT-SET-003 | APIキー設定 | user_id, APIキー | 暗号化して保存 |

---

## テストデータ

### テスト用PDFファイル

| ファイル名 | サイズ | 内容 | 用途 |
|-----------|-------|------|------|
| `test_simple.pdf` | 100KB | テキストのみ | 基本テスト |
| `test_images.pdf` | 2MB | 画像3枚含む | 画像抽出テスト |
| `test_tables.pdf` | 500KB | 表5つ含む | 表抽出テスト |
| `test_complex.pdf` | 5MB | 複合コンテンツ | 統合テスト |

### テスト用ユーザー

| メール | パスワード | 用途 |
|--------|-----------|------|
| `test@example.com` | `testpass123` | 一般テスト |
| `admin@example.com` | `admin123` | 管理者テスト |

---

## テスト実行方法

### 環境準備
```bash
cd src/backend
pip install pytest pytest-cov pytest-asyncio
```

### テスト実行
```bash
# 全テスト実行
pytest tests/ -v

# カバレッジレポート付き
pytest tests/ -v --cov=app --cov-report=html

# 特定モジュールのみ
pytest tests/test_security.py -v
```

### ディレクトリ構成
```
src/backend/
├── tests/
│   ├── __init__.py
│   ├── conftest.py          # フィクスチャ定義
│   ├── test_security.py     # セキュリティテスト
│   ├── test_auth_service.py # 認証サービステスト
│   ├── test_template_service.py
│   ├── test_conversion_service.py
│   ├── test_converters/
│   │   ├── test_pymupdf.py
│   │   ├── test_pdfplumber.py
│   │   └── test_manager.py
│   └── test_settings_service.py
└── app/
```

---

## 集計

| カテゴリ | テスト件数 |
|---------|----------|
| 認証・セキュリティ | 8件 |
| 認証サービス | 5件 |
| テンプレートサービス | 6件 |
| 変換サービス | 4件 |
| PDFコンバーター | 9件 |
| 設定サービス | 3件 |
| **合計** | **35件** |

---

## 変更履歴
| 日付 | 版 | 変更内容 | 変更者 |
|------|-----|----------|--------|
| 2025-12-12 | 1.0 | 初版作成 | Claude (AIPM) |
| 2025-12-16 | 1.1 | テスト項目詳細記載 | Claude (AIPM) |

---

## AIレビュー結果
- レビュー日: 2025-12-16
- レビュアー: Claude (AIPM)
- 結果: **適切**
- コメント: コア機能（認証・暗号化）のテストが網羅されている。E2EテストはPhase 5で実施するため、API層の単体テストは省略して問題なし。
