# 外部インターフェース定義書

## 概要
RePage PDFシステムが連携する外部サービス・APIのインターフェース定義です。
Phase1では学習対象サイトへのHTTP接続、LLM API（OpenAI/Anthropic）との連携を定義します。

## ステータス
- **フェーズ**: 基本設計
- **作成日**: 2025-12-13
- **更新日**: 2025-12-13
- **作成者**: Claude (AIPM)
- **レビュー状況**: 未着手

---

## 内容

### 外部インターフェース一覧

| IF-ID | インターフェース名 | 接続先 | 方向 | プロトコル | 用途 |
|-------|-------------------|--------|------|-----------|------|
| IF-001 | 学習対象サイト取得 | 任意のWebサイト | OUT | HTTPS | テンプレート学習用HTML取得 |
| IF-002 | OpenAI API | api.openai.com | OUT | HTTPS | HTML生成、PDF解析（Vision） |
| IF-003 | Anthropic API | api.anthropic.com | OUT | HTTPS | HTML生成、PDF解析（Vision） |

---

### IF-001: 学習対象サイト取得

#### 基本情報

| 項目 | 内容 |
|------|------|
| 接続先 | ユーザーが指定した任意のURL |
| プロトコル | HTTP/HTTPS |
| 認証 | なし（公開ページ対象） |
| タイムアウト | 60秒（JS実行待ち含む） |
| **取得方式** | **ヘッドレスブラウザ（Playwright）** |

#### 動的ページ対応

JavaScriptで動的に生成されるコンテンツを取得するため、ヘッドレスブラウザ（Playwright）を使用します。

**使用ライブラリ:** `playwright`（Python）

```python
from playwright.async_api import async_playwright

async def fetch_dynamic_page(url: str) -> str:
    async with async_playwright() as p:
        browser = await p.chromium.launch(headless=True)
        context = await browser.new_context(
            user_agent="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36",
            viewport={"width": 1920, "height": 1080},
            locale="ja-JP"
        )
        page = await context.new_page()

        # ページ読み込み（JS実行完了まで待機）
        await page.goto(url, wait_until="networkidle")

        # 追加の待機（動的コンテンツ用）
        await page.wait_for_timeout(2000)

        # レンダリング後のHTMLを取得
        html = await page.content()

        # CSSも取得
        stylesheets = await page.evaluate('''() => {
            return Array.from(document.styleSheets)
                .filter(sheet => sheet.href)
                .map(sheet => sheet.href);
        }''')

        await browser.close()
        return html, stylesheets
```

#### リクエスト設定

**ユーザーエージェント（通常ブラウザと同一）:**
```
Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36
```

**ブラウザ設定:**
| 項目 | 設定値 |
|------|--------|
| User-Agent | 最新のChrome UA（定期更新） |
| Viewport | 1920x1080 |
| Locale | ja-JP |
| Accept-Language | ja,en-US;q=0.9,en;q=0.8 |
| JavaScript | 有効 |
| Cookie | 許可 |

**注意:** ボットと識別されないよう、以下を遵守：
- 一般的なブラウザのUser-Agentを使用
- 適切なリクエスト間隔（最低1秒）を設ける
- robots.txtを尊重（設定で無視可能）

#### レスポンス

| 項目 | 内容 |
|------|------|
| 成功 | JS実行後のレンダリング済みHTML |
| 取得データ | HTML（DOM構築後）、外部CSSリスト |

#### エラーハンドリング

| エラー種別 | 対応 |
|------------|------|
| 403 Forbidden | ユーザーにアクセス拒否を通知 |
| 404 Not Found | ユーザーにURL無効を通知 |
| 500系 | リトライ（最大3回）後、エラー通知 |
| タイムアウト（60秒超過） | リトライ（最大2回）後、エラー通知 |
| ブラウザクラッシュ | リトライ（最大2回）後、エラー通知 |

---

### IF-002: OpenAI API

#### 基本情報

| 項目 | 内容 |
|------|------|
| 接続先 | https://api.openai.com/v1 |
| プロトコル | HTTPS |
| 認証 | Bearer Token（APIキー） |
| レート制限 | プランに依存 |

#### 使用エンドポイント

##### 1. Chat Completions（HTML生成）

```
POST https://api.openai.com/v1/chat/completions
Headers:
  Authorization: Bearer {OPENAI_API_KEY}
  Content-Type: application/json
```

**リクエストボディ:**
```json
{
  "model": "gpt-4o-mini",
  "messages": [
    {
      "role": "system",
      "content": "あなたはPDFコンテンツをHTMLに変換するアシスタントです。以下のコーディングルールに従ってください:\n{learned_rules}"
    },
    {
      "role": "user",
      "content": "以下のPDFから抽出したコンテンツをHTMLに変換してください:\n{extracted_content}"
    }
  ],
  "max_tokens": 8000,
  "temperature": 0.3
}
```

**レスポンス:**
```json
{
  "choices": [
    {
      "message": {
        "content": "<article>...</article>"
      }
    }
  ],
  "usage": {
    "prompt_tokens": 1000,
    "completion_tokens": 2000,
    "total_tokens": 3000
  }
}
```

##### 2. Vision API（PDF画像解析）

```
POST https://api.openai.com/v1/chat/completions
Headers:
  Authorization: Bearer {OPENAI_API_KEY}
  Content-Type: application/json
```

**リクエストボディ:**
```json
{
  "model": "gpt-4o-mini",
  "messages": [
    {
      "role": "user",
      "content": [
        {
          "type": "text",
          "text": "このPDFページからテキストと構造を抽出してください。表があれば表形式で、画像があればその説明を含めてください。"
        },
        {
          "type": "image_url",
          "image_url": {
            "url": "data:image/png;base64,{base64_encoded_image}"
          }
        }
      ]
    }
  ],
  "max_tokens": 4000
}
```

#### エラーハンドリング

| エラーコード | 対応 |
|-------------|------|
| 401 Unauthorized | APIキー無効をユーザーに通知 |
| 429 Rate Limit | 指数バックオフでリトライ |
| 500 Server Error | リトライ（最大3回） |
| context_length_exceeded | コンテンツを分割して再試行 |

---

### IF-003: Anthropic API

#### 基本情報

| 項目 | 内容 |
|------|------|
| 接続先 | https://api.anthropic.com/v1 |
| プロトコル | HTTPS |
| 認証 | x-api-key ヘッダー |
| レート制限 | プランに依存 |

#### 使用エンドポイント

##### 1. Messages API（HTML生成）

```
POST https://api.anthropic.com/v1/messages
Headers:
  x-api-key: {ANTHROPIC_API_KEY}
  anthropic-version: 2023-06-01
  Content-Type: application/json
```

**リクエストボディ:**
```json
{
  "model": "claude-3-haiku-20240307",
  "max_tokens": 8000,
  "system": "あなたはPDFコンテンツをHTMLに変換するアシスタントです。以下のコーディングルールに従ってください:\n{learned_rules}",
  "messages": [
    {
      "role": "user",
      "content": "以下のPDFから抽出したコンテンツをHTMLに変換してください:\n{extracted_content}"
    }
  ]
}
```

**レスポンス:**
```json
{
  "content": [
    {
      "type": "text",
      "text": "<article>...</article>"
    }
  ],
  "usage": {
    "input_tokens": 1000,
    "output_tokens": 2000
  }
}
```

##### 2. Vision（PDF画像解析）

**リクエストボディ:**
```json
{
  "model": "claude-3-haiku-20240307",
  "max_tokens": 4000,
  "messages": [
    {
      "role": "user",
      "content": [
        {
          "type": "text",
          "text": "このPDFページからテキストと構造を抽出してください。"
        },
        {
          "type": "image",
          "source": {
            "type": "base64",
            "media_type": "image/png",
            "data": "{base64_encoded_image}"
          }
        }
      ]
    }
  ]
}
```

#### エラーハンドリング

| エラーコード | 対応 |
|-------------|------|
| 401 Authentication Error | APIキー無効をユーザーに通知 |
| 429 Rate Limit | 指数バックオフでリトライ |
| 529 Overloaded | リトライ（最大3回） |

---

### 内部REST API一覧（フロント-バック間）

| メソッド | エンドポイント | 用途 |
|----------|---------------|------|
| POST | /api/auth/login | ログイン |
| POST | /api/auth/logout | ログアウト |
| GET | /api/auth/me | 認証状態確認 |
| GET | /api/templates | テンプレート一覧 |
| POST | /api/templates | テンプレート作成 |
| GET | /api/templates/{id} | テンプレート詳細 |
| DELETE | /api/templates/{id} | テンプレート削除 |
| POST | /api/templates/{id}/learn | URL学習実行 |
| POST | /api/conversions/upload | PDFアップロード |
| GET | /api/conversions/{id} | 変換結果取得 |
| POST | /api/conversions/{id}/generate | HTML生成 |
| PATCH | /api/conversions/{id} | HTML編集保存 |
| POST | /api/conversions/{id}/approve | 承認 |
| GET | /api/conversions/{id}/download | HTMLダウンロード |
| GET | /api/conversions/{id}/images | 画像ZIP取得 |
| GET | /api/settings/converters | コンバーター一覧 |
| PUT | /api/settings/converters | コンバーター設定 |
| PUT | /api/settings/api-keys | APIキー設定 |
| GET | /api/settings/models | 利用可能モデル一覧 |
| PUT | /api/settings/models | モデル設定変更 |

---

### Phase2以降の外部インターフェース（参考）

| IF-ID | インターフェース名 | 接続先 | 用途 |
|-------|-------------------|--------|------|
| IF-101 | WordPress REST API | 顧客WordPressサイト | 記事投稿 |

---

## 変更履歴
| 日付 | 版 | 変更内容 | 変更者 |
|------|-----|----------|--------|
| 2025-12-13 | 1.0 | 初版作成 | Claude (AIPM) |
| 2025-12-16 | 1.1 | IF-001:Playwright動的ページ対応、IF-002/003:廉価モデル(gpt-4o-mini/claude-3-haiku)に変更、モデル設定API追加 | Claude (AIPM) |

---

## AIレビュー結果

### レビュー日: 2025-12-16
### レビュアー: Claude (AIPM)
### 結果: **承認**

#### 確認項目

| 項目 | 結果 | 備考 |
|------|------|------|
| IF-001 動的ページ対応 | OK | Playwright + networkidle待機 |
| IF-001 User-Agent設定 | OK | 標準Chrome UA（ステルス対応） |
| IF-002/003 LLMモデル | OK | gpt-4o-mini / claude-3-haiku（廉価版） |
| 内部API一覧の網羅性 | OK | 20エンドポイント |
| エラーハンドリング定義 | OK | HTTP/API別に明記 |
| Phase2 IF分離 | OK | IF-101として分離 |

#### 指摘事項
- なし
