# システム構成図

## 概要
RePage PDFシステムのアーキテクチャ、HW/SW構成、ネットワーク構成を定義します。
シンプルな構成（SQLite + ローカルストレージ）を基本とし、スケールアップ時にPostgreSQLへ切替可能な設計です。

## ステータス
- **フェーズ**: 基本設計
- **作成日**: 2025-12-13
- **更新日**: 2025-12-13
- **作成者**: Claude (AIPM)
- **レビュー状況**: 未着手

---

## 内容

### システム全体構成図

```mermaid
graph TB
    subgraph Client["クライアント"]
        Browser[ブラウザ<br>Chrome/Firefox/Safari]
    end

    subgraph Server["EC2 Linux サーバー"]
        subgraph Frontend["フロントエンド"]
            Next[Next.js<br>TypeScript]
        end

        subgraph Backend["バックエンド"]
            FastAPI[FastAPI<br>Python 3.11+]

            subgraph Converters["PDFコンバーター（切替可能）"]
                PyMuPDF[PyMuPDF]
                pdfplumber[pdfplumber]
                OpenAIVision[OpenAI Vision]
                ClaudeVision[Claude Vision]
            end
        end

        subgraph Storage["データストレージ"]
            SQLite[(SQLite<br>./data/repage.db)]
            LocalFS[ローカルFS<br>./storage/]
        end
    end

    subgraph External["外部サービス"]
        OpenAI[OpenAI API]
        Claude[Anthropic API]
        TargetSite[学習対象サイト]
    end

    Browser -->|HTTPS| Next
    Next -->|REST API| FastAPI
    FastAPI --> SQLite
    FastAPI --> LocalFS
    FastAPI --> Converters
    Converters --> OpenAI
    Converters --> Claude
    FastAPI -->|HTTP Fetch| TargetSite
```

### レイヤー構成図

```mermaid
graph LR
    subgraph Presentation["プレゼンテーション層"]
        UI[React Components]
        Pages[Next.js Pages]
    end

    subgraph Application["アプリケーション層"]
        Router[API Router]
        Service[Service Layer]
        Converter[Converter Manager]
    end

    subgraph Domain["ドメイン層"]
        Template[Template Entity]
        Conversion[Conversion Entity]
        User[User Entity]
    end

    subgraph Infrastructure["インフラ層"]
        DB[Database<br>SQLAlchemy]
        FS[File Storage]
        ExtAPI[External API Client]
    end

    UI --> Pages
    Pages --> Router
    Router --> Service
    Service --> Converter
    Service --> Domain
    Domain --> DB
    Domain --> FS
    Converter --> ExtAPI
```

### PDFコンバーター切替アーキテクチャ

```mermaid
classDiagram
    class ConverterInterface {
        <<interface>>
        +extract_text(pdf_path) str
        +extract_images(pdf_path) List[Image]
        +extract_tables(pdf_path) List[Table]
    }

    class PyMuPDFConverter {
        +extract_text(pdf_path) str
        +extract_images(pdf_path) List[Image]
        +extract_tables(pdf_path) List[Table]
    }

    class PdfPlumberConverter {
        +extract_text(pdf_path) str
        +extract_images(pdf_path) List[Image]
        +extract_tables(pdf_path) List[Table]
    }

    class OpenAIVisionConverter {
        -api_key: str
        +extract_text(pdf_path) str
        +extract_images(pdf_path) List[Image]
        +extract_tables(pdf_path) List[Table]
    }

    class ClaudeVisionConverter {
        -api_key: str
        +extract_text(pdf_path) str
        +extract_images(pdf_path) List[Image]
        +extract_tables(pdf_path) List[Table]
    }

    class ConverterManager {
        -current_converter: ConverterInterface
        +set_converter(type: str)
        +convert(pdf_path) ConversionResult
    }

    ConverterInterface <|.. PyMuPDFConverter
    ConverterInterface <|.. PdfPlumberConverter
    ConverterInterface <|.. OpenAIVisionConverter
    ConverterInterface <|.. ClaudeVisionConverter
    ConverterManager --> ConverterInterface
```

---

### HW構成

#### 基本構成（Phase1）

| 項目 | スペック | 備考 |
|------|----------|------|
| EC2インスタンス | t3.medium (2vCPU, 4GB) | 開発・検証環境 |
| EBSボリューム | gp3 50GB | OS + アプリ + データ |
| ストレージ | ローカル ./storage | PDF/画像保存 |

#### スケールアップ構成（将来）

| 項目 | スペック | 備考 |
|------|----------|------|
| EC2インスタンス | t3.large (2vCPU, 8GB) | 本番環境 |
| RDS | db.t3.small PostgreSQL | DB分離時 |
| EFS | 汎用 | 共有ストレージ（複数インスタンス時） |

---

### SW構成

| レイヤー | 技術 | バージョン | 備考 |
|----------|------|------------|------|
| OS | Amazon Linux 2023 | 最新 | |
| Runtime | Node.js | 20.x LTS | フロントエンド |
| Runtime | Python | 3.11+ | バックエンド |
| フロントエンド | Next.js | 14.x | App Router |
| フロントエンド | React | 18.x | |
| フロントエンド | TypeScript | 5.x | |
| UIライブラリ | Tailwind CSS | 3.x | Notionライクなデザイン |
| バックエンド | FastAPI | 0.100+ | |
| ORM | SQLAlchemy | 2.x | |
| データベース | SQLite | 3.x | 標準 |
| データベース | PostgreSQL | 15.x | 切替可能 |
| PDF処理 | PyMuPDF | 1.23+ | |
| PDF処理 | pdfplumber | 0.10+ | 表抽出 |
| 画像処理 | Pillow | 10.x | |
| HTTPクライアント | httpx | 0.25+ | 非同期対応 |

---

### ディレクトリ構成

```
repage_pdf/
├── frontend/                   # Next.js フロントエンド
│   ├── src/
│   │   ├── app/               # App Router
│   │   ├── components/        # React コンポーネント
│   │   ├── lib/               # ユーティリティ
│   │   └── styles/            # スタイル
│   ├── public/
│   └── package.json
│
├── backend/                    # FastAPI バックエンド
│   ├── app/
│   │   ├── api/               # APIルーター
│   │   ├── core/              # 設定・認証
│   │   ├── models/            # SQLAlchemy モデル
│   │   ├── schemas/           # Pydantic スキーマ
│   │   ├── services/          # ビジネスロジック
│   │   └── converters/        # PDFコンバーター
│   ├── requirements.txt
│   └── main.py
│
├── scripts/                    # 運用スクリプト
│   ├── repage-pdf.sh          # 統合管理スクリプト（start/stop/restart/status）
│   ├── install-service.sh     # systemdサービス登録スクリプト
│   └── systemd/               # systemdユニットファイル
│       ├── repage-frontend.service
│       └── repage-backend.service
│
├── storage/                    # ローカルファイルストレージ
│   ├── uploads/               # アップロードPDF
│   ├── images/                # 抽出画像
│   └── outputs/               # 生成HTML
│
├── data/                       # データベース
│   └── repage.db              # SQLite DB
│
├── .env.example               # 環境変数テンプレート
├── docker-compose.yml          # 開発環境用
└── README.md                   # セットアップ手順
```

---

### systemdサービス構成

GitHubに公開するシステムにおける起動スクリプトの推奨配置方法です。

#### 配置方針

| 方針 | 説明 |
|------|------|
| **リポジトリ内に同梱** | scripts/ディレクトリに起動スクリプトとsystemdユニットファイルを配置 |
| **インストールスクリプト提供** | ユーザーが`install-service.sh`を実行してsystemdに登録 |
| **環境非依存** | パスは環境変数または設定ファイルで指定 |

#### scripts/repage-pdf.sh（統合管理スクリプト）

```bash
#!/bin/bash
# RePage PDF 統合管理スクリプト
# Usage: ./repage-pdf.sh {start|stop|restart|status}

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"

case "$1" in
    start)
        echo "Starting RePage PDF..."
        sudo systemctl start repage-frontend
        sudo systemctl start repage-backend
        echo "Started."
        ;;
    stop)
        echo "Stopping RePage PDF..."
        sudo systemctl stop repage-frontend
        sudo systemctl stop repage-backend
        echo "Stopped."
        ;;
    restart)
        echo "Restarting RePage PDF..."
        sudo systemctl restart repage-frontend
        sudo systemctl restart repage-backend
        echo "Restarted."
        ;;
    status)
        echo "=== Frontend Status ==="
        sudo systemctl status repage-frontend --no-pager
        echo ""
        echo "=== Backend Status ==="
        sudo systemctl status repage-backend --no-pager
        ;;
    *)
        echo "Usage: $0 {start|stop|restart|status}"
        exit 1
        ;;
esac
```

#### scripts/systemd/repage-frontend.service

```ini
[Unit]
Description=RePage PDF Frontend (Next.js)
After=network.target

[Service]
Type=simple
User=ec2-user
WorkingDirectory=/path/to/repage_pdf/frontend
Environment=NODE_ENV=production
Environment=PORT=3013
ExecStart=/usr/bin/npm run start
Restart=on-failure
RestartSec=10

[Install]
WantedBy=multi-user.target
```

#### scripts/systemd/repage-backend.service

```ini
[Unit]
Description=RePage PDF Backend (FastAPI)
After=network.target

[Service]
Type=simple
User=ec2-user
WorkingDirectory=/path/to/repage_pdf/backend
EnvironmentFile=/path/to/repage_pdf/.env
ExecStart=/path/to/venv/bin/uvicorn main:app --host 0.0.0.0 --port 8018
Restart=on-failure
RestartSec=10

[Install]
WantedBy=multi-user.target
```

#### scripts/install-service.sh

```bash
#!/bin/bash
# systemdサービス登録スクリプト
# Usage: sudo ./install-service.sh /path/to/repage_pdf

PROJECT_DIR="${1:-$(dirname $(dirname $(realpath $0)))}"
SCRIPT_DIR="$PROJECT_DIR/scripts"

echo "Installing RePage PDF services..."
echo "Project directory: $PROJECT_DIR"

# パスを置換してユニットファイルをコピー
for service in repage-frontend repage-backend; do
    sed "s|/path/to/repage_pdf|$PROJECT_DIR|g" \
        "$SCRIPT_DIR/systemd/${service}.service" \
        > /etc/systemd/system/${service}.service
done

# systemdをリロード
systemctl daemon-reload

# サービスを有効化
systemctl enable repage-frontend
systemctl enable repage-backend

echo "Services installed. Use 'scripts/repage-pdf.sh start' to start."
```

---

### ネットワーク構成

#### 基本構成（単一サーバー）

| 項目 | 設定値 | 備考 |
|------|--------|------|
| プロトコル | HTTPS (443) | Let's Encrypt |
| フロントエンド | localhost:3013 | Next.js |
| バックエンド | localhost:8018 | FastAPI |
| リバースプロキシ | Nginx | SSL終端 |

#### ポート構成

```mermaid
graph LR
    Internet[インターネット] -->|443| Nginx
    Nginx -->|3013| Next.js
    Nginx -->|8018| FastAPI
```

---

### 環境変数設計

```bash
# データベース（切替可能）
DATABASE_URL=sqlite:///./data/repage.db
# DATABASE_URL=postgresql://user:pass@localhost:5432/repage

# ストレージ
STORAGE_PATH=./storage

# 認証
JWT_SECRET_KEY=your-secret-key
JWT_ALGORITHM=HS256
JWT_EXPIRE_MINUTES=1440

# PDFコンバーター
DEFAULT_CONVERTER=pymupdf  # pymupdf | pdfplumber | openai | claude

# LLMモデル（設定画面で変更可能）
OPENAI_MODEL=gpt-4o-mini      # gpt-4o-mini | gpt-4o
ANTHROPIC_MODEL=claude-3-haiku-20240307  # claude-3-haiku-20240307 | claude-3-5-sonnet-20241022

# 外部API
OPENAI_API_KEY=sk-xxx
ANTHROPIC_API_KEY=sk-ant-xxx
```

---

## 変更履歴
| 日付 | 版 | 変更内容 | 変更者 |
|------|-----|----------|--------|
| 2025-12-13 | 1.0 | 初版作成 | Claude (AIPM) |
| 2025-12-13 | 1.1 | systemdサービス構成追加、ポート変更(FE:3013, BE:8018) | Claude (AIPM) |
| 2025-12-16 | 1.2 | 環境変数にLLMモデル設定追加 | Claude (AIPM) |

---

## AIレビュー結果

### レビュー日: 2025-12-16
### レビュアー: Claude (AIPM)
### 結果: **承認（修正後）**

#### 確認項目

| 項目 | 結果 | 備考 |
|------|------|------|
| 技術スタック要件との整合性 | OK | Next.js/FastAPI/SQLite構成 |
| ポート番号設定 | OK | FE:3013, BE:8018 |
| systemd構成の妥当性 | OK | scripts/配下に配置 |
| 環境変数の網羅性 | OK | モデル設定追加済み |
| ディレクトリ構成の明確性 | OK | 役割明記 |

#### 修正履歴
- 環境変数にLLMモデル設定（OPENAI_MODEL, ANTHROPIC_MODEL）追加
