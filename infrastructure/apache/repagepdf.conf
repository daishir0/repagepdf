# RePage PDF - Apache Reverse Proxy Configuration
# FQDN: repagepdf.path-finder.jp
# Frontend: localhost:3013 (Next.js)
# Backend: localhost:8018 (FastAPI)

# HTTP -> HTTPS redirect
<VirtualHost *:80>
    ServerName repagepdf.path-finder.jp

    # Redirect all HTTP to HTTPS
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
</VirtualHost>

# HTTPS configuration
<VirtualHost *:443>
    ServerName repagepdf.path-finder.jp

    # SSL Configuration (Let's Encrypt - using path-finder.jp wildcard)
    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/path-finder.jp/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/path-finder.jp/privkey.pem

    # Proxy settings
    ProxyPreserveHost On
    ProxyRequests Off

    # WebSocket support for Next.js HMR (development)
    RewriteEngine On
    RewriteCond %{HTTP:Upgrade} websocket [NC]
    RewriteCond %{HTTP:Connection} upgrade [NC]
    RewriteRule ^/?(.*) ws://127.0.0.1:3013/$1 [P,L]

    # Backend API proxy
    ProxyPass /api http://127.0.0.1:8018/api
    ProxyPassReverse /api http://127.0.0.1:8018/api

    # Frontend proxy (everything else)
    ProxyPass / http://127.0.0.1:3013/
    ProxyPassReverse / http://127.0.0.1:3013/

    # Headers
    RequestHeader set X-Forwarded-Proto "https"
    RequestHeader set X-Forwarded-Host "repagepdf.path-finder.jp"

    # Logging
    ErrorLog /var/log/httpd/repagepdf_error.log
    CustomLog /var/log/httpd/repagepdf_access.log combined
</VirtualHost>
